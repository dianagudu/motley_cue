---
include:
  - 'https://git.scc.kit.edu/m-team/ci-voodoo/raw/master/ci-include/generic-ci.yml'
  - 'https://git.scc.kit.edu/m-team/ci-voodoo/raw/master/ci-include/pipeline-jobs.yml'

variables:
  STAGING_BRANCH_NAME: 'staging'
  DOCKER_IMAGE_NAMESPACE: 'marcvs/build'
  DOCKER_IMAGE_NAME: 'motley-cue'
  PREREL_BRANCH_NAME: 'ci/fix-bionic-anotherone'
  REPO_USER: 'thisisatest'
  JUST_A_TEST: 'marcusistesting'

build-centos-7:
  extends:
    - .build-centos-7
  before_script:
    - |
      echo "### before-script ################################# x ##########"
      echo "CI_COMMIT_REF_NAME: ${CI_COMMIT_REF_NAME}"
      echo "CI_COMMIT_BRANCH:   ${CI_COMMIT_BRANCH}"
      echo "CI_DEFAULT_BRANCH:  ${CI_DEFAULT_BRANCH}"
      echo "CI_PIPELINE_SOURCE: ${CI_PIPELINE_SOURCE}"
      echo "CI_UPSTREAM_PIPELINE_SOURCE:  ${CI_UPSTREAM_PIPELINE_SOURCE}"
      echo "CI_UPSTREAM_COMMIT_BRANCH:    $CI_UPSTREAM_COMMIT_BRANCH"
      echo "CI_UPSTREAM_DEFAULT_BRANCH:   $CI_UPSTREAM_DEFAULT_BRANCH"
      echo "RESOLVE_DEPENDENCIES_REPO:    $RESOLVE_DEPENDENCIES_REPO"
      echo "DISTRO:  ${DISTRO}"
      echo "RELEASE: ${RELEASE}"
      echo "CI_UPSTREAM_PROJECT_NAME:   $CI_UPSTREAM_PROJECT_NAME"
      echo "CI_UPSTREAM_PROJECT_PATH:   $CI_UPSTREAM_PROJECT_PATH"
      echo "CI_UPSTREAM_BUILD_REF:      $CI_UPSTREAM_BUILD_REF"
      echo "CI_UPSTREAM_BUILD_REF_NAME: $CI_UPSTREAM_BUILD_REF_NAME"
      echo "CI_UPSTREAM_JOB_NAME:       $CI_UPSTREAM_JOB_NAME"
      echo "CI_UPSTREAM_COMMIT_REF_NAME: $CI_UPSTREAM_COMMIT_REF_NAME"
      echo "### -------------- ##############################################"
      echo "ANYBRANCH_RESOLVE_DEPENDENCIES_REPO:    $ANYBRANCH_RESOLVE_DEPENDENCIES_REPO"
      echo "ANYBRANCH_PUBLISH_RESULTS_REPO:         $ANYBRANCH_PUBLISH_RESULTS_REPO"
      echo "PREREL_RESOLVE_DEPENDENCIES_REPO:       $PREREL_RESOLVE_DEPENDENCIES_REPO"
      echo "PREREL_PUBLISH_RESULTS_REPO:            $PREREL_PUBLISH_RESULTS_REPO"
      echo "PREPROD_RESOLVE_DEPENDENCIES_REPO:      $PREPROD_RESOLVE_DEPENDENCIES_REPO"
      echo "PREPROD_PUBLISH_RESULTS_REPO:           $PREPROD_PUBLISH_RESULTS_REPO"
      echo "PREREL_BRANCH_NAME:             $PREREL_BRANCH_NAME"
      echo "UPSTREAM_PREREL_BRANCH_NAME:    $UPSTREAM_PREREL_BRANCH_NAME"
      echo "REPO_USER: $REPO_USER"
      echo "UPSTREAM_REPO_USER: $UPSTREAM_REPO_USER"
      echo "OTHERWISE_UNDEFINED_VARIABLE: $OTHERWISE_UNDEFINED_VARIABLE"

  script:
    - |
      # Force RPM's python-bytecompile script to use python3
      sed "s@^default_python@default_python=python3\n#default_python@" -i /usr/lib/rpm/brp-python-bytecompile
      echo "typing-extensions" >> requirements.txt
    - make rpms

build-ubuntu-bionic:
  extends:
    - .build-ubuntu-bionic
  script:
    - |
      cat debian/rules \
      | sed s/"dh_virtualenv --python python3"/"dh_virtualenv --python python3.8"/ \
      > debian/new-rules
      cat debian/new-rules > debian/rules
      make debsource
      dpkg-buildpackage -uc -us

##########################################################################
# Integration (These might to to a central job def)
integration-tests:
  variables:
    UPSTREAM_PREREL_BRANCH_NAME: $PREREL_BRANCH_NAME
    OTHERWISE_UNDEFINED_VARIABLE: $PREREL_BRANCH_NAME
  extends:
    - .trigger-integration-tests-ssh-oidc

publish-to-devel:
  extends:
    - .publish-to-devel

publish-to-prerel:
  extends:
    - .publish-to-prerel

publish-to-preprod:
  extends:
    - .publish-to-preprod












